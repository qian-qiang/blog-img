---
title: 提升EMC的软件编程策略
top: false
cover: false
toc: true
mathjax: true
date: 2023-05-09 09:02:29
password:
summary:
tags:
- EMC-EMI
categories:
- Embedded system
keywords:
description:
---

# EMC [简介](https://qian-qiang.github.io/2023/04/emc-emi.html)

# 有哪些电磁失效可能？

由于EMC干扰的注入，对于一个电子系统而言，可能会引起哪些功能失效呢？

- 微控制器无响应 ：怎么会呢？比如因为干扰原因，软件采集的一个错误的输入值，导致进入了死锁。
- PC指针失控，软件跑飞
- 执行意外指令
- 错误的地址指向，数据损坏或丢失
- 子例程执行错误
- 设备重启和/或外部异常中断
- IP 配置损坏 
- I/O表现异常，比如显示屏花屏，按键功能失效，继电器乱动，模数采样噪声增加，数模输出异常.......

软件故障的后果示例：
- 产品意外响应 
- 上下文丢失
- 进程中的意外分支 
- 中断丢失 
- 数据完整性缺失
- 输入值误读

# 软件编程策略

## 使用硬件&软件看门狗
为了确保MCU能够从软件失控故障中恢复，看门狗是最有效的可用工具。
软件看门狗的原理：它是一个在计数结束时产生MCU复位的定时器。一旦看门狗启动，
防止看门狗复位控制器的唯一方式就是在程序中周期性更新计数器。
硬件看门狗：单独的看门狗芯片（eg:tps3823），在单位时间内软件没进行喂狗操作看门狗芯
片就会输出硬件复位信号到MCU芯片进行复位

## 保护闲置程序存储区域
在大多数应用中，程序存储空间并没有完全被用户代码占满。为了更强的安全性，如果你不想产
生复位，可以使用代码填满闲置存储位置，这样会强制看门狗复位或者跳向已知的程序位置。 
    即使程序计数器损坏，并且跳向闲置存储位置，这都将确保MCU恢复和返回到正常操作。在这个闲
置区域，还可以跳转到恢复故障安全子程序，通过该子程序可恢复正常运行。
    带有 ARM® Cortex®-M 内核的 STM32 微控制器使用故障异常，当系统遭受EMC干扰时， 它可
以捕获可能发生的非法存储访问和非法编程行为。未定义的指令操作代码可以用来填充STM32微控制器的闲置存储，在程序计数器失控的情况下，提高故障异常使用率，使得故障安全程序从错误中恢复。

## 闲置中断向量管理
为了避免意外中断事件导致的问题（无论是什么来源），建议在相应的向量中加入一个有效的中
断程序地址，以管理所有可能的中断来源。未使用的中断向量指向故障管理程序标签，该标签中填充了简单的 “ 从中断返回 ” 指令

void exception_isr(void)
{
    /*将异常中断记录或者如有可能显示*/
    record_exception_isr();
    /*让程序一直在这里死循环，通过看门狗让系统自动重启*/
    while(1);
}
在可能的情况下将出现这种异常中断记录并显示，同时进入死循环，利用前面说的看门狗技术让系统重启，或者进入设备安全状态。

## 谨慎IO策略
为啥干扰会注入，下图就是一个直观的例子，干扰最终会在数字系统中引起输入脉冲，这是异常行为:
输入通道**：包括开关量输入，模数采样输入，可以采用滤波策略。比如开关量输入在既有的硬件输入滤波措施的基础上，可以采用诸如多次检测去抖动策略。

/*伪码描述一下思路*/
#define FILTER_TIMES  6
#define SAMPLE_TIMES  10
#define GET_IO_BIT(X)  PA##X /*硬件体系不同，具体实现修改*/
bool read_io()
{
    uint8 counter = 0;
    for(int i=0;i<SAMPLE_TIMES;i++)
        counter += GET_IO_BIT(0);
    /*大于门限占比则认为是高电平状态*/
    if(counter>=FILTER_TIMES)
        return true;
    else
        return false;
}
这里仅仅描述一个思路，具体实现时，还需要考虑多次采样，中间是否需要加延时，你可以看成对开关量调整其采样率，进而做出合理判断。如果只读一次，则在干扰注入时，非常容易读取错误的信息。

对于一个模数采样而言，可以利用数字滤波器技术滤除噪声，消除噪声对系统的影响，在一些资源相对有限的系统，推荐使用一阶数字滤波器或者移动均值滤波器去处理。当然使用时需要合理选择截至频率，防止将真实有用信号频率干掉，导致正常功能也无法使用

输出通道：比如显示输出，比如LCD显示屏，可以增加刷新率，这样即使在某个瞬态设备被干扰了，由于刷新及时，那么外在显示就不会出现。人眼就可能无法识别，当然这是一个健壮措施。如果遇到这样的问题，还是建议从硬件上尽量将干扰切断或者降低注入的程度。对于电压模数输出，在可能的情况下，可以尝试采用工业4-20mA的标准，去传递信息。4-20mA标准在抗干扰方面性能优异。

## 掉电检测存储技术
一个电子系统的供电最容易被干扰，因此可以结合硬件设计一个掉电检测及短时板级UPS电路，检测出系统单片机/DSP供电被干扰到可能将要重启时，电路将备用供电切上，同时将关键运行时参数马上存储在非易失介质中（比如EEPROM/FRAM），如果系统真的无法抵抗干扰导致设备重启，在系统上电时，检测重启原因以及数据，如果识别出是由于短时掉电重启的，将介质中数据导入，恢复现场，系统继续执行。

## 冗余数据存储和交换
数据在EMC场景下遭受磨坏，如果内部没有恢复机制，设备可能出现意想不到的表现。尤其在功能
安全性要求很高行业，比如航空、医疗、汽车、工业等环境下。电子设备编程都会采用数据备份策略，对于关键安全功能链的内存数据都会强制要求采用备份数据机制，比如在IEC61508中就有强制要求。

将关键功能对应的运行时参数（在内存中的全局变量)，都做一个备份。并利用链接绑定技术，将
这些参数存储在两片连续的内存区中。在写某个参数时，同时也写备份参数。然后在一个后台中去检查两块区域是否相等，如果不相等则可能发生了致命的错误，可以采集故障报警或者设备重启的策略

## 健壮的通信协议设计
电子系统或多或少都需要与其他设备进行通信，那么设计一个健壮的通信协议也是提高抗干扰措施的一个重要手段，比如增加CRC报文完整性检查，增加错误重传机制，通信故障检测机制等等

## 留意低频信号
比如系统中出现喇叭。RGB灯等相对系统来说比较高频率的信号需要特别留意。这些信号有可能会和安装和设计问题结合起来形成一个射频天线产生额外的辐射。这些高频信号应该及时提供给硬件工程师分析。

# 总结
EMC就是个无聊的游戏